// Prisma Schema for Abilene Salas Multi-Branch Booking Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ADMIN ====================
model Admin {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  role         String   @default("owner") // owner, manager
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("admins")
}

// ==================== BRANCHES (SUCURSALES) ====================
model Branch {
  id                 String   @id @default(uuid())
  name               String   // "DASH Studio Centro"
  slug               String   @unique // "dash-centro"
  address            String
  phone              String?
  googleMapsUrl      String?  @map("google_maps_url")
  imageUrl           String?  @map("image_url")
  maxBookingsPerDay  Int      @default(10) @map("max_bookings_per_day")
  isActive           Boolean  @default(true) @map("is_active")
  sortOrder          Int      @default(0) @map("sort_order")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  schedules      BranchSchedule[]
  blockedDates   BlockedDate[]
  branchServices BranchService[]
  bookings       Booking[]
  galleryItems   GalleryItem[]
  promotions     Promotion[]

  @@map("branches")
}

model BranchSchedule {
  id        String   @id @default(uuid())
  branchId  String   @map("branch_id")
  dayOfWeek Int      @map("day_of_week") // 0=Sun, 1=Mon, ..., 6=Sat
  startTime String   @map("start_time") // "09:00"
  endTime   String   @map("end_time")   // "18:00"
  isActive  Boolean  @default(true) @map("is_active")

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([branchId, dayOfWeek])
  @@map("branch_schedules")
}

model BlockedDate {
  id          String   @id @default(uuid())
  branchId    String   @map("branch_id")
  blockedDate DateTime @map("blocked_date") @db.Date
  reason      String?
  createdAt   DateTime @default(now()) @map("created_at")

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([branchId, blockedDate])
  @@map("blocked_dates")
}

// ==================== SERVICES ====================
model Service {
  id              String   @id @default(uuid())
  name            String
  description     String?
  price           Decimal  @db.Decimal(10, 2)
  durationMinutes Int      @default(60) @map("duration_minutes")
  category        String   // "micropigmentacion", "pestanas", "laser"
  imageUrl        String?  @map("image_url")
  isGlobal        Boolean  @default(true) @map("is_global") // Available in all branches
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  branchServices BranchService[]
  bookings       Booking[]

  @@map("services")
}

model BranchService {
  id          String   @id @default(uuid())
  branchId    String   @map("branch_id")
  serviceId   String   @map("service_id")
  customPrice Decimal? @map("custom_price") @db.Decimal(10, 2) // Override price for this branch
  isAvailable Boolean  @default(true) @map("is_available")

  branch  Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([branchId, serviceId])
  @@map("branch_services")
}

// ==================== CLIENTS ====================
model Client {
  id               String    @id @default(uuid())
  name             String
  phone            String    @unique
  email            String?
  notes            String?
  preferredBranchId String?  @map("preferred_branch_id")
  totalVisits      Int       @default(0) @map("total_visits")
  lastVisit        DateTime? @map("last_visit")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  bookings Booking[]

  @@map("clients")
}

// ==================== BOOKINGS ====================
enum BookingStatus {
  PENDING       // Clienta envió solicitud
  COUNTER_OFFER // Dueña propuso otra fecha
  CONFIRMED     // Ambas partes aceptaron
  REJECTED      // Dueña rechazó
  CANCELLED     // Clienta canceló o rechazó contrapropuesta
  COMPLETED     // Servicio realizado
  NO_SHOW       // Clienta no asistió
}

model Booking {
  id                String        @id @default(uuid())
  clientId          String        @map("client_id")
  branchId          String        @map("branch_id")
  serviceId         String        @map("service_id")
  
  // Dates
  requestedDate     DateTime      @map("requested_date") @db.Date // Client's preferred date
  proposedDateTime  DateTime?     @map("proposed_datetime") // Admin's counter-offer
  confirmedDateTime DateTime?     @map("confirmed_datetime") // Final confirmed date/time
  
  // Status
  status            BookingStatus @default(PENDING)
  
  // Notes
  clientNotes       String?       @map("client_notes")
  adminNotes        String?       @map("admin_notes")
  
  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  client       Client            @relation(fields: [clientId], references: [id])
  branch       Branch            @relation(fields: [branchId], references: [id])
  service      Service           @relation(fields: [serviceId], references: [id])
  messageLogs  WhatsAppMessageLog[]

  @@map("bookings")
}

// ==================== WHATSAPP MESSAGES ====================
model WhatsAppMessageLog {
  id             String   @id @default(uuid())
  bookingId      String?  @map("booking_id")
  clientPhone    String   @map("client_phone")
  messageType    String   @map("message_type") // "request_received", "confirmation", "counter_offer", "reminder_24h", "reminder_2h", "follow_up"
  templateName   String?  @map("template_name")
  messageContent String?  @map("message_content")
  status         String   @default("pending") // "pending", "sent", "delivered", "read", "failed"
  waMessageId    String?  @map("wa_message_id") // WhatsApp message ID
  errorMessage   String?  @map("error_message")
  sentAt         DateTime @default(now()) @map("sent_at")

  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@map("whatsapp_message_logs")
}

// ==================== GALLERY ====================
model GalleryItem {
  id        String   @id @default(uuid())
  branchId  String?  @map("branch_id") // NULL = global (all branches)
  mediaUrl  String   @map("media_url")
  mediaType String   @default("image") @map("media_type") // "image", "video"
  category  String?  // Service category for filtering
  caption   String?
  sortOrder Int      @default(0) @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  branch Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@map("gallery_items")
}

// ==================== PROMOTIONS ====================
model Promotion {
  id              String    @id @default(uuid())
  branchId        String?   @map("branch_id") // NULL = global (all branches)
  title           String
  description     String?
  discountPercent Decimal?  @map("discount_percent") @db.Decimal(5, 2)
  imageUrl        String?   @map("image_url")
  startDate       DateTime  @map("start_date") @db.Date
  endDate         DateTime  @map("end_date") @db.Date
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  branch Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@map("promotions")
}

// ==================== BUSINESS CONFIG ====================
model BusinessConfig {
  id               String   @id @default(uuid())
  businessName     String   @default("Abilene Salas") @map("business_name")
  logoUrl          String?  @map("logo_url")
  primaryColor     String   @default("#d4a574") @map("primary_color")
  whatsappNumber   String?  @map("whatsapp_number")
  instagramHandle  String?  @map("instagram_handle")
  facebookUrl      String?  @map("facebook_url")
  timezone         String   @default("America/Mexico_City")
  welcomeMessage   String?  @map("welcome_message")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("business_config")
}
